name: VPS
on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'ุนุฏุฏ ุณุงุนุงุช ุงูุชุดุบูู (0 = ุฏุงุฆู)'
        required: true
        default: '0'
        type: string

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0  # ุฅุฒุงูุฉ ุงููููุฉ ุงูุฒูููุฉ
    
    steps:
      - name: ุฅูุดุงุก SSH Key ุขูู
        id: ssh_key
        run: |
          ssh-keygen -t ed25519 -f /tmp/vps_key -N "" -q
          PRIVATE_KEY=$(cat /tmp/vps_key | base64 -w 0)
          PUBLIC_KEY=$(cat /tmp/vps_key.pub)
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "::add-mask::$PRIVATE_KEY"
          echo "private_key=$PRIVATE_KEY" >> $GITHUB_OUTPUT
          
      - name: ุชุซุจูุช ูุชูููู SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server ufw fail2ban
          
          # ุชุนุทูู ุชุณุฌูู ุงูุฏุฎูู ุจูููุฉ ุงููุฑูุฑ
          echo "PermitRootLogin prohibit-password" | sudo tee -a /etc/ssh/sshd_config
          echo "PasswordAuthentication no" | sudo tee -a /etc/ssh/sshd_config
          
          # ุฅุถุงูุฉ ุงูููุชุงุญ ุงูุนุงู ูููุณุชุฎุฏู ุงูุญุงูู
          mkdir -p ~/.ssh
          echo "${{ env.PUBLIC_KEY }}" >> ~/.ssh/authorized_keys
          
          # ุชุฃููู ุงูุฎุงุฏู
          sudo ufw allow ssh
          sudo ufw allow 41641/udp  # Tailscale
          sudo ufw --force enable
          
          sudo systemctl restart ssh
          echo "โ SSH ูููู ุจุงุณุชุฎุฏุงู ุงููุตุงุฏูุฉ ุจุงูููุชุงุญ ููุท"

      - name: ุชุซุจูุช Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=vps-${{ github.run_id }} \
            --accept-dns=false \
            --ssh
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=vps-${{ github.run_id }}" >> $GITHUB_ENV
          echo "โ Tailscale IP: $tsIP"

      - name: ุชุซุจูุช ุฃุฏูุงุช ุงููุฑุงูุจุฉ
        run: |
          sudo apt install -y htop net-tools tmux
          echo "ุงูุฎุงุฏู ุฌุงูุฒ ูููุฑุงูุจุฉ"

      - name: ุนุฑุถ ูุนูููุงุช ุงูุงุชุตุงู
        run: |
          echo "========================================="
          echo "          ๐ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู"
          echo "========================================="
          echo ""
          echo "๐ก ูุนูููุงุช ุงูุงุชุตุงู:"
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "ุงุณู ุงููุถูู: ${{ env.TAILSCALE_HOSTNAME }}"
          echo ""
          echo "๐ ูุนูููุงุช SSH:"
          echo "1. ุฅุณุชุฎุฏู: ssh root@${{ env.TAILSCALE_IP }}"
          echo "2. ุฃู ุนุจุฑ Tailscale SSH:"
          echo "   ssh ${{ env.TAILSCALE_HOSTNAME }}"
          echo ""
          echo "๐ ุงูููุชุงุญ ุงูุฎุงุต ููุงุชุตุงู (Base64):"
          echo "${{ steps.ssh_key.outputs.private_key }}"
          echo ""
          echo "๐ก ูุชุญููู ุงูููุชุงุญ:"
          echo 'echo "$KEY" | base64 -d > vps_key && chmod 600 vps_key'
          echo 'ssh -i vps_key root@${{ env.TAILSCALE_IP }}'
          echo "========================================="
          echo "โฐ ุงููุฏุฉ: ${{ github.event.inputs.duration_hours }} ุณุงุนุฉ (0 = ุฏุงุฆู)"

      - name: ุฅุจูุงุก ุงูุฎุงุฏู ูุดุทุงู
        id: keep_alive
        run: |
          # ุญุณุงุจ ุงููููุฉ ุงูุฒูููุฉ
          DURATION=${{ github.event.inputs.duration_hours }}
          
          if [ "$DURATION" = "0" ]; then
            echo "๐ ุชุดุบูู ุงูุฎุงุฏู ุจุดูู ุฏุงุฆู..."
            echo "๐ก ุฌุงูุฒ ููุงุณุชุฎุฏุงู"
            echo ""
            echo "๐ ูุนูููุงุช ุงูุดุจูุฉ:"
            ip a
            echo ""
            echo "๐ ุญุงูุฉ ุงููุธุงู:"
            tailscale status
            echo ""
            echo "โ ูุฅููุงู ุงูุฎุงุฏูุ ุฃูุบู ุชุดุบูู Workflow ูู GitHub Actions"
            
            # ุชุดุบูู ุณุฌู ูููุฑุงูุจุฉ
            while true; do
              echo "[$(date +'%Y-%m-%d %H:%M:%S')] VPS ูุนูู ุจุดูู ุทุจูุนู"
              echo "  ๐ค ุงููุณุชุฎุฏููู ุงููุดุทูู: $(who | wc -l)"
              echo "  ๐ ุชุญููู ุงููุธุงู: $(uptime)"
              sleep 60
            done
          else
            echo "โฑ๏ธ ุชุดุบูู ุงูุฎุงุฏู ููุฏุฉ $DURATION ุณุงุนุฉ..."
            SECONDS=$((DURATION * 3600))
            
            for ((i=1; i<=SECONDS/60; i++)); do
              echo "[$(date +'%Y-%m-%d %H:%M:%S')] VPS ูุนูู - ุงูุฏูููุฉ $i/$((SECONDS/60))"
              sleep 60
            done
            
            echo "โฐ ุงูุชูุช ุงููุฏุฉ ุงูุฒูููุฉ"
          fi

      - name: ุชูุธูู ูุจู ุงูุฅุบูุงู
        if: always()
        run: |
          echo "๐งน ุชูุธูู ุงูุฎุงุฏู..."
          # ุฅุฒุงูุฉ ุงูููุงุชูุญ ุงููุคูุชุฉ
          rm -f /tmp/vps_key /tmp/vps_key.pub
          # ุฅููุงู Tailscale
          sudo tailscale down || true
          echo "โ ุชู ุงูุชูุธูู"
